<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vota #53 Martin Carabal√≠ - Pacto Hist√≥rico</title>
    <!-- D3.js para el mapa -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8f4f8 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #003366 0%, #004d99 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-text {
            text-align: center;
        }

        .logo {
            width: 260px;
            height: 260px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 2.5rem;
            color: #003366;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            border: 5px solid #ffd700;
            flex-shrink: 0;
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .lema {
            font-size: 1.3rem;
            font-style: italic;
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        .numero-candidato {
            background: #ffd700;
            color: #003366;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 0.5rem;
            font-size: 1.2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .party-info {
            background: white;
            padding: 2.5rem;
            margin: 2rem 0;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #004d99;
        }

        /* =============================== */
        /* üéØ SISTEMA DE FILTROS */
        /* =============================== */
        .filters-section {
            background: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .filters-section h2 {
            color: #003366;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .search-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            padding: 0.8rem 1rem;
            border: 2px solid #e6f2ff;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #004d99;
        }

        .filter-select {
            padding: 0.8rem 1rem;
            border: 2px solid #e6f2ff;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            min-width: 200px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #004d99;
        }

        .filter-info {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        /* =============================== */
        /* üó∫Ô∏è MAPA DE COLOMBIA */
        /* =============================== */
        .map-section {
            background: white;
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .map-section h2 {
            color: #003366;
            margin-bottom: 1.5rem;
            text-align: center;
        }

       #colombia-map {
            width: 100%;
            height: 1000px;
            background: #f8fbff;
            border-radius: 10px;
            overflow: hidden;
        }

        .department-path {
            fill: #ff9c03;
            stroke: #cc7d02;
            stroke-width: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .department-path:hover {
            fill: #e68a00;
            stroke: #b36b00;
            stroke-width: 2;
        }
        
        .department-path.seleccionado {
            fill: #cc7d02;
            stroke: #ff9c03;
            stroke-width: 2;
        }

        .department-path.filtrado {
            opacity: 0.3 !important;
            fill: #cccccc !important;
        }

        .department-label {
            font-size: 12px;
            font-weight: bold;
            fill: #003366;
            pointer-events: none;
            text-anchor: middle;
        }

        .map-tooltip {
            position: absolute;
            background: rgba(0, 51, 102, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        /* =============================== */
        /* üéØ MODAL DE DELEGADOS */
        /* =============================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            right: 1.5rem;
            top: 1rem;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #003366;
        }

        #modal-titulo {
            color: #003366;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #004d99;
            padding-bottom: 0.5rem;
        }

        .delegado-item {
            background: #f8fbff;
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            border-left: 4px solid #004d99;
            transition: transform 0.2s ease;
        }

        .delegado-item:hover {
            transform: translateX(5px);
            background: #e6f2ff;
        }

        .delegado-nombre {
            font-weight: bold;
            color: #003366;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .delegado-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .delegado-comision {
            background: #003366;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .delegado-votos {
            background: #004d99;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .delegado-votos:hover {
            background: #003366;
            transform: scale(1.05);
        }

        footer {
            background: linear-gradient(135deg, #003366 0%, #002244 100%);
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .no-results {
            text-align: center;
            color: #666;
            padding: 2rem;
            font-style: italic;
        }

        .sync-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .sync-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .sync-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .sync-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* =============================== */
        /* üîÑ INDICADOR DE CARGA */
        /* =============================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #ff9c03;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            .modal-content { margin: 10% auto; width: 95%; }
            .search-container { flex-direction: column; }
            .search-box, .filter-select { min-width: 100%; }
            #colombia-map { height: 500px !important; }
            .department-label { font-size: 8px !important; }
            .map-tooltip { font-size: 12px !important; }
            .loading-text { font-size: 1.1rem; }
            .loading-spinner { width: 50px; height: 50px; }
        }
    </style>
</head>
<body>
   <header>
    <div class="header-content">
        <div class="logo">
            <img src="Martin.jpg" alt="Martin Carabal√≠ - Candidato #53">
        </div>
        <div class="header-text">
        <h1>Vota Senado #53 Martin Carabal√≠</h1>
        
        <p class="lema">"Todo Parece imposible hasta que se hace"</p>
        <div class="numero-candidato">#53</div>
    </header>

    <div class="container">
        <section class="party-info" style="display: none;">
            <h2>Nuestro Compromiso con Colombia</h2>
            <p>El Pacto Hist√≥rico representa la esperanza de un cambio verdadero para Colombia. Con Martin Carabal√≠ como candidato, trabajamos por una naci√≥n m√°s justa, equitativa y llena de oportunidades para todos los colombianos.</p>
        </section>

        <!-- =============================== -->
        <!-- üéØ SISTEMA DE FILTROS -->
        <!-- =============================== -->
        <section class="filters-section">
            <h2>Delegados por Departamento</h2>
            <div id="sync-status" class="sync-status sync-loading">
                üîÑ Cargando datos desde Google Sheets...
            </div>
            <div class="search-container">
                <input type="text" id="search-input" class="search-box" placeholder="üîç Buscar delegado por nombre...">
                <select id="comision-filter" class="filter-select">
                    <option value="">Todas las comisiones</option>
                </select>
                <select id="departamento-filter" class="filter-select">
                    <option value="">Todos los departamentos</option>
                </select>
            </div>
            <div class="filter-info">
                <p id="filter-results">Mostrando todos los delegados</p>
            </div>
        </section>

        <!-- =============================== -->
        <!-- üó∫Ô∏è MAPA DE COLOMBIA -->
        <!-- =============================== -->
        <section class="map-section">
            <h2>Departamentos de Colombia</h2>
            <div id="colombia-map"></div>
        </section>
    </div>

    <!-- =============================== -->
    <!-- üéØ MODAL DE DELEGADOS -->
    <!-- =============================== -->
    <div id="modal-delegados" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3 id="modal-titulo">Delegados - Departamento</h3>
            <div id="lista-delegados"></div>
        </div>
    </div>

    <!-- =============================== -->
    <!-- üîÑ INDICADOR DE CARGA -->
    <!-- =============================== -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">
            <strong>Cargando datos desde Google Sheets...</strong>
        </div>
        <div class="loading-subtext">
            Esto puede tomar unos segundos
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Martin Carabal√≠. Todos los derechos reservados.</p>
            <p>#53 - Todo Parece imposible hasta que se hace</p>
        </div>
    </footer>

    <script>
        // ============================================
        // üîó CONFIGURACI√ìN - TU GOOGLE SHEETS
        // ============================================
        const SHEET_ID = '1EMWCl1lWkDncMpNxj7NnsnXMd9JoTmhw-FfbXa_J7QM';
        const SHEET_NAME = 'Sheet1'; // Cambia esto si usas otra hoja

        // Variable global para almacenar los delegados
        let delegadosPorDepartamento = {};

        // ============================================
        // üó∫Ô∏è C√ìDIGO DEL MAPA Y FUNCIONALIDAD
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('modal-delegados');
            const modalTitulo = document.getElementById('modal-titulo');
            const listaDelegados = document.getElementById('lista-delegados');
            const closeModal = document.querySelector('.close-modal');
            const searchInput = document.getElementById('search-input');
            const comisionFilter = document.getElementById('comision-filter');
            const departamentoFilter = document.getElementById('departamento-filter');
            const filterResults = document.getElementById('filter-results');
            const mapContainer = document.getElementById('colombia-map');
            const syncStatus = document.getElementById('sync-status');
            const loadingOverlay = document.getElementById('loading-overlay');

            let mapaCargado = false;

            // Inicializar la aplicaci√≥n
            async function inicializar() {
                // Mostrar loading inmediatamente
                loadingOverlay.style.display = 'flex';
                
                await cargarDatosDesdeSheets();
                cargarFiltros();
                cargarMapaColombia();
                agregarEventListeners();
                actualizarResultados();
                
                // Programar actualizaci√≥n autom√°tica cada 60 segundos
                setInterval(async () => {
                    await cargarDatosDesdeSheets();
                    cargarFiltros();
                    actualizarResultados();
                    actualizarMapaConFiltros();
                }, 60000);
            }

            // ============================================
            // üîó CONEXI√ìN CON GOOGLE SHEETS
            // ============================================
            async function cargarDatosDesdeSheets() {
    const loadingOverlay = document.getElementById('loading-overlay');
    
    try {
        loadingOverlay.style.display = 'flex';
        syncStatus.className = 'sync-status sync-loading';
        syncStatus.innerHTML = 'üîÑ Sincronizando con Google Sheets...';

        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('Error al cargar el Google Sheets');
        }
        
        const text = await response.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const filas = json.table.rows || [];

        // Crear NUEVO objeto para evitar problemas
        const nuevosDatos = {};

        // Procesar filas (empezando desde la fila 1 para saltar encabezados)
        for (let i = 1; i < filas.length; i++) {
            const fila = filas[i];
            const celdas = fila.c || [];
            
            // Asumir columnas: [Departamento, Nombre, Comisi√≥n, Votos]
            const departamento = celdas[0]?.v || '';
            const nombre = celdas[1]?.v || '';
            const comision = celdas[2]?.v || '';
            const votos = parseInt(celdas[3]?.v) || 0;

            // Solo procesar si tiene datos b√°sicos
            if (departamento && nombre) {
                if (!nuevosDatos[departamento]) {
                    nuevosDatos[departamento] = [];
                }
                
                nuevosDatos[departamento].push({
                    nombre: nombre,
                    comision: comision,
                    votos: votos,
                    enlace: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit#gid=0`
                });
            }
        }

        // ACTUALIZAR los datos globales DE UNA VEZ
        delegadosPorDepartamento = nuevosDatos;

        syncStatus.className = 'sync-status sync-success';
        const totalDelegados = Object.values(delegadosPorDepartamento).reduce((acc, curr) => acc + curr.length, 0);
        syncStatus.innerHTML = `‚úÖ Sincronizado: ${totalDelegados} delegados cargados - Pr√≥xima actualizaci√≥n en 60 segundos`;

        console.log('üìä Datos cargados correctamente');

    } catch (error) {
        console.error('‚ùå Error cargando datos:', error);
        syncStatus.className = 'sync-status sync-error';
        syncStatus.innerHTML = `‚ùå Error sincronizando: ${error.message}`;
    } finally {
        // OCULTAR LOADING (siempre se ejecuta)
        loadingOverlay.style.display = 'none';
    }
}

            // Cargar el mapa de Colombia
            function cargarMapaColombia() {
                const width = mapContainer.clientWidth;
                const height = 1000;

                const svg = d3.select("#colombia-map")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

                const g = svg.append("g");

                // Crear tooltip
                const tooltip = d3.select("body")
                    .append("div")
                    .attr("class", "map-tooltip")
                    .style("opacity", 0);

                // Cargar el GeoJSON
                d3.json("https://gist.githubusercontent.com/john-guerra/43c7656821069d00dcbc/raw/3aadedf47badbdac823b00dbe259f6bc6d9e1899/colombia.geo.json")
                    .then(function(colombia) {
                        console.log("‚úÖ GeoJSON cargado:", colombia);
                        
                        // Proyecci√≥n
                        const isMobile = window.innerWidth < 768;
                        const baseScale = isMobile ? 2000 : 3000;

                        let center = [-74, 4.5];
                        let translate = [width / 2, height / 2];

                        if (isMobile) {
                            translate = [width / 2, height / 1.8];
                        }

                        const projection = d3.geoMercator()
                            .center(center)
                            .scale(baseScale)
                            .translate(translate);

                        const path = d3.geoPath().projection(projection);

                        // DIBUJAR FORMAS PRIMERO (paths)
                        g.selectAll("path")
                            .data(colombia.features)
                            .enter()
                            .append("path")
                            .attr("class", "department-path")
                            .attr("d", path)
                            .attr("data-depto", d => d.properties.NOMBRE_DPT)
                            .on("mouseover", function(event, d) {
                                const deptoMapa = d.properties.NOMBRE_DPT;
                                const departamentoEnDatos = mapearNombreDepartamento(deptoMapa);
                                const delegados = delegadosPorDepartamento[departamentoEnDatos] || [];
                                const cantidad = delegados.length;
                            console.log(`üñ±Ô∏è Mouse over: ${deptoMapa} -> ${departamentoEnDatos} -> ${cantidad} delegados`);
                                
                                tooltip.transition().duration(200).style("opacity", .9);
                                tooltip.html(`<strong>${deptoMapa}</strong><br/>${cantidad} delegado${cantidad !== 1 ? 's' : ''}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 28) + "px");

                                d3.select(this).style("fill", "#004d99");
                            })
                            .on("mouseout", function(d) {
                                tooltip.transition().duration(500).style("opacity", 0);
                                d3.select(this).style("fill", "#ff9c03");
                            })
                            .on("click", function(event, d) {
                                const depto = d.properties.NOMBRE_DPT;
                                mostrarDelegados(depto);
                                
                                // Resaltar selecci√≥n
                                g.selectAll(".department-path").style("fill", "#ff9c03");
                                d3.select(this).style("fill", "#cc7d02");
                            });

                        // LUEGO ETIQUETAS
                        g.selectAll("text")
                            .data(colombia.features)
                            .enter()
                            .append("text")
                            .attr("class", "department-label")
                            .attr("transform", d => `translate(${path.centroid(d)})`)
                            .attr("dy", ".35em")
                            .text(d => {
                                const nombre = d.properties.NOMBRE_DPT;
                                if (nombre === "Norte de Santander") return "N. Santander";
                                if (nombre === "Archipi√©lago de San Andr√©s") return "San Andr√©s";
                                if (nombre.length > 8) return nombre.substring(0, 8) + ".";
                                return nombre;
                            });

                        mapaCargado = true;
                    })
                    .catch(function(error) {
                        console.error("‚ùå Error cargando el mapa:", error);
                        mapContainer.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <h3>Error cargando el mapa</h3>
                                <p>No se pudo cargar el mapa de Colombia: ${error.message}</p>
                            </div>
                        `;
                    });
            }

            // Funci√≥n para mapear nombres entre GeoJSON y datos
            // Funci√≥n COMPLETA para mapear nombres de TODOS los departamentos
// Funci√≥n COMPLETA para mapear TODOS los departamentos
// Funci√≥n COMPLETA que maneja may√∫sculas, min√∫sculas y tildes
// Funci√≥n COMPLETA para TODOS los departamentos
// Funci√≥n COMPLETA con may√∫sculas, tildes y todo
function mapearNombreDepartamento(nombreGeoJSON) {
    // Funci√≥n para normalizar texto
    function normalizarTexto(texto) {
        return texto
            .toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9 ]/g, '')
            .replace(/\s+/g, ' ')
            .trim();
    }

    // 1. PRIMERO: Convertir may√∫sculas a formato normal
    if (nombreGeoJSON === nombreGeoJSON.toUpperCase()) {
        const convertido = nombreGeoJSON.charAt(0) + nombreGeoJSON.slice(1).toLowerCase();
        console.log(`üîÑ Convertido may√∫sculas: "${nombreGeoJSON}" -> "${convertido}"`);
        nombreGeoJSON = convertido;
    }

    // 2. MAPEO MANUAL para casos especiales
    const mapeoEspecial = {
        "Bogot√°": "Bogot√° D.C.",
        "Archipi√©lago de San Andr√©s, Providencia y Santa Catalina": "San Andr√©s", 
        "San Andr√©s": "San Andr√©s"
    };
    
    if (mapeoEspecial[nombreGeoJSON]) {
        return mapeoEspecial[nombreGeoJSON];
    }

    // 3. BUSCAR en datos existentes con normalizaci√≥n
    const nombreNormalizado = normalizarTexto(nombreGeoJSON);
    const departamentosEnDatos = Object.keys(delegadosPorDepartamento);
    
    for (const depto of departamentosEnDatos) {
        const deptoNormalizado = normalizarTexto(depto);
        if (deptoNormalizado === nombreNormalizado) {
            console.log(`‚úÖ Coincidencia normalizada: "${nombreGeoJSON}" -> "${depto}"`);
            return depto;
        }
    }

    // 4. Si no encuentra, devolver el original
    return nombreGeoJSON;
}

            // Cargar opciones de filtros
            function cargarFiltros() {
                const departamentosData = Object.keys(delegadosPorDepartamento).sort();
                let comisionesUnicas = new Set();

                // Cargar comisiones √∫nicas
                Object.values(delegadosPorDepartamento).forEach(delegados => {
                    delegados.forEach(delegado => {
                        if (delegado.comision) {
                            comisionesUnicas.add(delegado.comision);
                        }
                    });
                });

                // Agregar opciones de comisi√≥n al select
                comisionFilter.innerHTML = '<option value="">Todas las comisiones</option>';
                [...comisionesUnicas].sort().forEach(comision => {
                    const option = document.createElement('option');
                    option.value = comision;
                    option.textContent = comision;
                    comisionFilter.appendChild(option);
                });

                // Agregar opciones de departamento al select
                departamentoFilter.innerHTML = '<option value="">Todos los departamentos</option>';
                departamentosData.forEach(depto => {
                    const option = document.createElement('option');
                    option.value = depto;
                    option.textContent = depto;
                    departamentoFilter.appendChild(option);
                });
            }

            // Actualizar mapa basado en filtros
            function actualizarMapaConFiltros() {
    if (!mapaCargado) return;

    const searchTerm = searchInput.value.toLowerCase();
    const comisionSeleccionada = comisionFilter.value;
    const departamentoSeleccionado = departamentoFilter.value;

    console.log("=== üîç ACTUALIZANDO MAPA CON FILTROS ===");
    console.log("T√©rmino b√∫squeda:", searchTerm);
    console.log("Comisi√≥n seleccionada:", comisionSeleccionada);
    console.log("Departamento seleccionado:", departamentoSeleccionado);

    d3.selectAll(".department-path")
        .classed("filtrado", function(d) {
            const deptoMapa = d.properties.NOMBRE_DPT;
            const departamentoEnDatos = mapearNombreDepartamento(deptoMapa);
            const delegadosDelDepto = delegadosPorDepartamento[departamentoEnDatos] || [];
            
            console.log(`üìç ${deptoMapa} -> ${departamentoEnDatos}: ${delegadosDelDepto.length} delegados`);
            
            // Si no hay delegados en este departamento, mostrar tenue
            if (delegadosDelDepto.length === 0) {
                console.log(`   ‚ùå SIN DELEGADOS`);
                return true;
            }
            
            // Aplicar filtros
            const tieneDelegadosFiltrados = delegadosDelDepto.some(delegado => {
                const coincideNombre = !searchTerm || delegado.nombre.toLowerCase().includes(searchTerm);
                const coincideComision = !comisionSeleccionada || delegado.comision === comisionSeleccionada;
                const coincideDepartamento = !departamentoSeleccionado || departamentoEnDatos === departamentoSeleccionado;
                
                const resultado = coincideNombre && coincideComision && coincideDepartamento;
                
                if (resultado) {
                    console.log(`   ‚úÖ COINCIDE: ${delegado.nombre}`);
                }
                
                return resultado;
            });
            
            console.log(`   üìä FILTRADO: ${!tieneDelegadosFiltrados}`);
            return !tieneDelegadosFiltrados;
        });
    
    console.log("=== ‚úÖ FIN ACTUALIZACI√ìN MAPA ===");
}

            // Agregar event listeners
            function agregarEventListeners() {
                closeModal.addEventListener('click', cerrarModal);
                window.addEventListener('click', (event) => {
                    if (event.target === modal) cerrarModal();
                });
                searchInput.addEventListener('input', function() {
                    actualizarResultados();
                    actualizarMapaConFiltros();
                });
                comisionFilter.addEventListener('change', function() {
                    actualizarResultados();
                    actualizarMapaConFiltros();
                });
                departamentoFilter.addEventListener('change', function() {
                    actualizarResultados();
                    actualizarMapaConFiltros();
                });

                // Redimensionar mapa cuando cambie el tama√±o de la ventana
                window.addEventListener('resize', function() {
                    if (mapaCargado) {
                        cargarMapaColombia();
                    }
                });
            }

            // Actualizar resultados basados en filtros
            function actualizarResultados() {
                const searchTerm = searchInput.value.toLowerCase();
                const comisionSeleccionada = comisionFilter.value;
                const departamentoSeleccionado = departamentoFilter.value;

                let delegadosFiltrados = 0;
                let departamentosConResultados = 0;

                Object.keys(delegadosPorDepartamento).forEach(depto => {
                    const delegados = delegadosPorDepartamento[depto] || [];
                    const delegadosFiltradosEnDepto = delegados.filter(delegado => {
                        const coincideNombre = delegado.nombre.toLowerCase().includes(searchTerm);
                        const coincideComision = !comisionSeleccionada || delegado.comision === comisionSeleccionada;
                        const coincideDepartamento = !departamentoSeleccionado || depto === departamentoSeleccionado;
                        
                        return coincideNombre && coincideComision && coincideDepartamento;
                    });

                    if (delegadosFiltradosEnDepto.length > 0) {
                        delegadosFiltrados += delegadosFiltradosEnDepto.length;
                        departamentosConResultados++;
                    }
                });

                // Actualizar texto de resultados
                let resultadosTexto = `Mostrando ${delegadosFiltrados} delegado${delegadosFiltrados !== 1 ? 's' : ''}`;
                if (comisionSeleccionada) resultadosTexto += ` en ${comisionSeleccionada}`;
                if (departamentoSeleccionado) resultadosTexto += ` de ${departamentoSeleccionado}`;
                if (searchTerm) resultadosTexto += ` que coinciden con "${searchTerm}"`;
                
                filterResults.textContent = resultadosTexto;
            }

            // Mostrar delegados en modal
            // Mostrar delegados en modal - VERSI√ìN CORREGIDA
// Mostrar delegados en modal - VERSI√ìN SIN FILTROS
function mostrarDelegados(nombreDepartamento) {
    console.log("üîç Mostrando delegados para:", nombreDepartamento);
    
    const departamentoFinal = mapearNombreDepartamento(nombreDepartamento);
    const delegados = delegadosPorDepartamento[departamentoFinal] || [];
    
    console.log("üìä Delegados encontrados:", delegados);
    console.log("üèõÔ∏è Departamento en datos:", departamentoFinal);
    console.log("üë• Cantidad de delegados:", delegados.length);

    // MOSTRAR TODOS LOS DELEGADOS SIN FILTROS
    const delegadosAMostrar = delegados;

    modalTitulo.textContent = `Delegados - ${nombreDepartamento} (${delegadosAMostrar.length})`;
    listaDelegados.innerHTML = '';

    if (delegadosAMostrar.length === 0) {
        listaDelegados.innerHTML = `
            <div class="no-results">
                <p>No hay delegados en este departamento</p>
                <p><small>Departamento: ${nombreDepartamento}</small></p>
                <p><small>Buscado como: ${departamentoFinal}</small></p>
            </div>
        `;
    } else {
        delegadosAMostrar.forEach(delegado => {
            const delegadoElement = document.createElement('div');
            delegadoElement.className = 'delegado-item';
            delegadoElement.innerHTML = `
                <div class="delegado-nombre">${delegado.nombre}</div>
                <div class="delegado-info">
                    <span class="delegado-comision">${delegado.comision}</span>
                    <span class="delegado-votos">
                        ${delegado.votos.toLocaleString()} votos
                    </span>
                </div>
            `;
            listaDelegados.appendChild(delegadoElement);
        });
    }

    modal.style.display = 'block';
    
    // DEBUG final
    console.log("‚úÖ Modal abierto con", delegadosAMostrar.length, "delegados");
}

            function cerrarModal() {
                modal.style.display = 'none';
                // Limpiar selecci√≥n del mapa
                d3.selectAll(".department-path").classed("seleccionado", false);
            }

            // Inicializar la aplicaci√≥n
            inicializar();
        });
    </script>
</body>
</html>
